name: Release

on:
    push:
        branches:
            - main

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
              - name: Checkout code
                uses: actions/checkout@v4
              - name: Set up Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '22'

              - name: Install pnpm
                uses: pnpm/action-setup@v2
                with:
                    version: 10

              - name: Install dependencies
                run: pnpm install

              - name: Get versions
                id: get_version
                run: |
                    echo "version=$(jq -r '.version' package.json)" >> $GITHUB_ENV
                    previous_version=$(git tag --sort=-v:refname | head -n 1 || echo "none")
                    echo "previous_version=$previous_version" >> $GITHUB_ENV


              - name: Check if package version has been bumped
                id: version_check
                run: |
                    echo "Current version: $version"

                    git fetch --tags
                    echo "Previous version: $previous_version"

                    if [ "$previous_version" != "none" ] && [ "$previous_version" == "v$current_version" ]; then
                        echo "Version has not been bumped. Exiting."
                        exit 1
                    fi
                    echo "Version has been bumped. Proceeding with release."


              - name: Publish package
                run:
                    pnpm run build
                    npm publish --access public
                if: steps.version_check.outcome == 'success'
                    
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                    NPM_TOKEN: ${{ secrets.NPM_TOKEN }}